<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SARRAFALAR ÇAVUŞ – إدارة الصناديق</title>
  <!-- Favicons (كل اللي طلبتها) -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#d4af37">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --primary: #0a0a0f;
      --primary-d: #000000;
      --gold: #d4af37;
      --gold-dark: #b8975e;
      --gold-glow: rgba(212,175,55,0.25);
      --success: #d4af37;
      --sell: #ef4444;
      --buy: #d4af37;
      --bg: #05050a;
      --card: #111118;
      --border: rgba(212,175,55,0.18);
      --text: #f3f4f6;
      --text-light: #9ca3af;
      --shadow: 0 8px 32px rgba(212,175,55,0.12);
      --radius: 16px;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Tajawal', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }
    header {
      background: linear-gradient(135deg, #000000, #0f0f17);
      color: var(--gold);
      padding: 1.2rem;
      text-align: center;
      box-shadow: 0 6px 24px rgba(212,175,55,0.15);
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.2rem;
    }
    .logo-img {
      max-width: 160px;
      height: auto;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(212,175,55,0.35);
    }
    .logo-text {
      font-size: 1.85rem;
      font-weight: 700;
      letter-spacing: 1.5px;
      color: white;
    }
    .container { max-width: 1180px; margin: 2.2rem auto; padding: 0 1.4rem; }
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 2.5rem;
    }
    .tab-btn {
      padding: 1rem 2.2rem;
      font-size: 1.12rem;
      font-weight: 600;
      border: 1px solid var(--gold-dark);
      border-radius: 999px;
      background: rgba(212,175,55,0.05);
      color: var(--gold);
      cursor: pointer;
      transition: all .3s;
    }
    .tab-btn:hover {
      background: rgba(212,175,55,0.18);
      transform: translateY(-3px);
      box-shadow: 0 10px 30px var(--gold-glow);
    }
    .tab-btn.active {
      background: var(--gold);
      color: var(--primary-d);
      border-color: var(--gold);
      box-shadow: 0 8px 25px rgba(212,175,55,0.3);
    }
    .section {
      background: var(--card);
      border-radius: var(--radius);
      padding: 2rem 1.8rem;
      box-shadow: var(--shadow);
      border: 1px solid rgba(212,175,55,0.2);
      display: none;
    }
    .section.active { display: block; }
    h2 {
      color: var(--gold);
      text-align: center;
      font-size: 1.9rem;
      margin-bottom: 1.8rem;
      position: relative;
    }
    h2::after {
      content: '';
      width: 100px;
      height: 4px;
      background: var(--gold);
      position: absolute;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      border-radius: 4px;
      box-shadow: 0 0 20px rgba(212,175,55,0.4);
    }
    .form-card {
      background: rgba(20,20,35,0.7);
      border: 1px solid rgba(212,175,55,0.25);
      border-radius: var(--radius);
      padding: 1.8rem;
      margin-bottom: 2rem;
      backdrop-filter: blur(10px);
    }
    .form-card h3 {
      text-align: center;
      color: var(--gold);
      margin-bottom: 1.4rem;
      font-size: 1.4rem;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.4rem;
    }
    label {
      display: block;
      margin-bottom: 0.6rem;
      font-weight: 600;
      color: var(--text-light);
      font-size: 1rem;
    }
    input, select {
      width: 100%;
      padding: 0.95rem 1.2rem;
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 10px;
      font-size: 1.05rem;
      background: rgba(255,255,255,0.03);
      color: white;
      transition: all .25s;
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 0 4px rgba(212,175,55,0.2);
      background: rgba(255,255,255,0.06);
    }
    /* === التعديل الجديد فقط: تحسين القوائم المنسدلة (select) === */
    select {
      background: #111118; /* خلفية سوداء داكنة */
      color: #f5d76e; /* نص ذهبي واضح */
      border: 1px solid #d4af37; /* حدود ذهبية رفيعة */
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23d4af37' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: left 1rem center;
      background-size: 12px;
      padding-right: 1rem;
    }
    select:focus {
      outline: none;
      border-color: #f5d76e;
      box-shadow: 0 0 0 4px rgba(245,215,110,0.2);
    }
    select option {
      background: #111118;
      color: #f5d76e;
      padding: 10px;
    }
    select option:not(:last-child) {
      border-bottom: 1px solid rgba(212,175,55,0.2); /* خط فاصل رفيع ذهبي */
    }
    select optgroup {
      font-weight: 700;
      color: var(--gold);
      background: rgba(20,20,35,0.9);
      padding: 8px;
    }
    .action-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1.2rem;
      justify-content: center;
      margin-top: 2rem;
    }
    .btn-action {
      padding: 1.1rem 3rem;
      font-size: 1.18rem;
      font-weight: 700;
      border: none;
      border-radius: 12px;
      color: white;
      cursor: pointer;
      min-width: 200px;
      transition: all .3s;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }
    .btn-sell { background: linear-gradient(135deg, #ef4444, #b91c1c); }
    .btn-buy { background: linear-gradient(135deg, var(--gold), var(--gold-dark)); }
    .btn-action:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 35px var(--gold-glow);
    }
    .report-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1.2rem;
      justify-content: center;
      margin: 1.8rem 0;
    }
    .report-btn {
      padding: 1rem 2.2rem;
      font-size: 1.05rem;
      font-weight: 600;
      border: none;
      border-radius: 999px;
      color: white;
      cursor: pointer;
      min-width: 170px;
      transition: all .25s;
    }
    .btn-day { background: var(--success); }
    .btn-week { background: #3b82f6; }
    .btn-print { background: var(--gold-dark); display: none; }
    .report-output {
      background: rgba(20,20,35,0.8);
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: var(--radius);
      padding: 1.8rem;
      margin: 2rem 0;
      display: none;
      backdrop-filter: blur(12px);
    }
    .report-output.show { display: block; }
    .report-table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.2rem 0;
      font-size: 0.98rem;
    }
    .report-table th, .report-table td {
      border: 1px solid rgba(212,175,55,0.25);
      padding: 1rem 1.2rem;
      text-align: right;
    }
    .report-table th {
      background: rgba(212,175,55,0.2);
      color: var(--gold);
      font-weight: 600;
    }
    .report-table tr:nth-child(even) { background: rgba(255,255,255,0.03); }
    .stock-summary {
      margin-top: 2rem;
      padding: 1.4rem;
      background: rgba(34,197,94,0.08);
      border-radius: 10px;
      border: 1px solid rgba(34,197,94,0.25);
    }
    .stock-summary h5 {
      margin-bottom: 1rem;
      color: var(--success);
      font-size: 1.2rem;
    }
    .total-profit {
      margin-top: 2rem;
      padding: 1.6rem;
      background: rgba(212,175,55,0.12);
      border-radius: 12px;
      text-align: center;
      font-size: 1.4rem;
      font-weight: 700;
      border: 1px solid rgba(212,175,55,0.35);
    }
    .positive { color: var(--buy); }
    .negative { color: var(--sell); }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.75);
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: var(--card);
      padding: 2rem 3rem;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(212,175,55,0.3);
      text-align: center;
      max-width: 460px;
      margin: 1rem;
      font-size: 1.2rem;
      border: 2px solid var(--gold);
    }
    .modal-content.success { color: var(--gold); }
    .modal-content.error { color: var(--sell); }
    @media print {
      header, .tabs, .form-card, .report-controls, .modal { display: none !important; }
      .report-output { display: block !important; margin: 0; padding: 0; border: none; background: white; box-shadow: none; }
      .print-logo { display: block !important; text-align: center; margin-bottom: 2.5rem; }
      .print-logo img { max-width: 260px; height: auto; }
      .report-table { page-break-inside: avoid; }
    }
    @media (max-width: 720px) {
      .form-grid { grid-template-columns: 1fr; }
      .action-row { flex-direction: column; }
      .btn-action { width: 100%; }
    }
  </style>
</head>
<body>
<header>
  <img src="logo.png" alt="SARRAFALAR ÇAVUŞ" class="logo-img">
  <div class="logo-text">SARRAFALAR ÇAVUŞ</div>
</header>
<div class="container">
  <div class="tabs">
    <button class="tab-btn active" data-tab="gold">صندوق الذهب</button>
    <button class="tab-btn" data-tab="currency">صندوق العملات</button>
    <button class="tab-btn" data-tab="transfer">صندوق الحوالات</button>
  </div>
  <!-- صندوق الذهب -->
  <div id="gold" class="section active">
    <h2>صندوق الذهب</h2>
    <div class="form-card">
      <h3>عملية ذهب</h3>
      <div class="form-grid">
        <div>
          <label>النوع / العيار</label>
          <select id="gold-type" onchange="updateGoldQuantityField()">
            <option value="">اختر النوع</option>
            <optgroup label="عيارات">
              <option value="karat-14">عيار 14</option>
              <option value="karat-18">عيار 18</option>
              <option value="karat-21">عيار 21</option>
              <option value="karat-24">عيار 24</option>
            </optgroup>
            <optgroup label="ليرات">
              <option value="lira">ليرات ذهب</option>
            </optgroup>
            <optgroup label="سبائك / أونصات">
              <option value="bars">سبائك / أونصات</option>
            </optgroup>
          </select>
        </div>
        <div id="quantity-container">
          <label id="quantity-label">الكمية</label>
          <input type="number" step="0.01" min="0.01" id="gold-qty" disabled placeholder="اختر النوع أولاً">
        </div>
        <div>
          <label>السعر TL</label>
          <input type="number" min="0" id="gold-total" placeholder="السعر الإجمالي بالليرة التركية">
        </div>
        <div>
          <label>ملاحظة</label>
          <input type="text" id="gold-note" placeholder="أدخل تفاصيل إضافية (مثال: اسم الزبون)">
        </div>
      </div>
      <div class="action-row">
        <button class="btn-action btn-sell" onclick="saveGold('sell')">
          <i class="fas fa-arrow-right-from-bracket"></i> بيع
        </button>
        <button class="btn-action btn-buy" onclick="saveGold('buy')">
          <i class="fas fa-arrow-right-to-bracket"></i> شراء
        </button>
      </div>
    </div>
    <div class="report-controls">
      <button class="report-btn btn-day" onclick="generateReport('gold','daily')">تقرير يومي</button>
      <button class="report-btn btn-week" onclick="generateReport('gold','weekly')">تقرير أسبوعي</button>
      <button class="report-btn btn-print" id="gold-print-btn" style="display:none;" onclick="printReport('gold')">
        <i class="fas fa-print"></i> طباعة / PDF
      </button>
    </div>
    <div id="gold-report" class="report-output"></div>
  </div>
  <!-- صندوق العملات -->
  <div id="currency" class="section">
    <h2>صندوق العملات</h2>
    <div class="form-card">
      <h3>عملية صرف</h3>
      <div class="form-grid">
        <div>
          <label>العملة</label>
          <select id="cur-type">
            <option value="EUR">EUR – يورو</option>
            <option value="USD">USD – دولار أمريكي</option>
            <option value="TRY">TRY – ليرة تركية</option>
            <option value="SAR">SAR – ريال سعودي</option>
            <option value="SYP">SYP – ليرة سورية</option>
          </select>
        </div>
        <div>
          <label>المبلغ</label>
          <input type="number" step="0.01" min="0" id="cur-amount" placeholder="المبلغ بالعملة المختارة">
        </div>
        <div>
          <label>سعر الصرف TL</label>
          <input type="number" step="0.01" min="0" id="cur-rate" placeholder="سعر الصرف مقابل TL">
        </div>
        <div>
          <label>ملاحظة</label>
          <input type="text" id="cur-note" placeholder="تفاصيل إضافية إن وجدت">
        </div>
      </div>
      <div class="action-row">
        <button class="btn-action btn-sell" onclick="saveCurrency('sell')">
          <i class="fas fa-arrow-right-from-bracket"></i> بيع
        </button>
        <button class="btn-action btn-buy" onclick="saveCurrency('buy')">
          <i class="fas fa-arrow-right-to-bracket"></i> شراء
        </button>
      </div>
    </div>
    <div class="report-controls">
      <button class="report-btn btn-day" onclick="generateReport('currency','daily')">تقرير يومي</button>
      <button class="report-btn btn-week" onclick="generateReport('currency','weekly')">تقرير أسبوعي</button>
      <button class="report-btn btn-print" id="currency-print-btn" style="display:none;" onclick="printReport('currency')">
        <i class="fas fa-print"></i> طباعة / PDF
      </button>
    </div>
    <div id="currency-report" class="report-output"></div>
  </div>
  <!-- صندوق الحوالات -->
  <div id="transfer" class="section">
    <h2>صندوق الحوالات</h2>
    <div class="form-card">
      <h3>عملية حوالة</h3>
      <div class="form-grid">
        <div>
          <label>الاسم الكامل</label>
          <input type="text" id="trans-name" placeholder="اسم المرسل / المستلم">
        </div>
        <div>
          <label>المبلغ</label>
          <input type="number" step="0.01" min="0" id="trans-amount" placeholder="المبلغ المرسل">
        </div>
        <div>
          <label>العمولة TL</label>
          <input type="number" step="0.01" min="0" id="trans-commission" placeholder="العمولة أو الرسوم">
        </div>
        <div>
          <label>نوع العملة</label>
          <select id="trans-currency">
            <option value="EUR">EUR</option>
            <option value="USD">USD</option>
            <option value="TRY">TRY</option>
            <option value="SAR">SAR</option>
            <option value="SYP">SYP</option>
          </select>
        </div>
      </div>
      <div class="action-row">
        <button class="btn-action btn-sell" onclick="saveTransfer('out')">
          <i class="fas fa-paper-plane"></i> صادرة
        </button>
        <button class="btn-action btn-buy" onclick="saveTransfer('in')">
          <i class="fas fa-download"></i> واردة
        </button>
      </div>
    </div>
    <div class="report-controls">
      <button class="report-btn btn-day" onclick="generateReport('transfer','daily')">تقرير يومي</button>
      <button class="report-btn btn-week" onclick="generateReport('transfer','weekly')">تقرير أسبوعي</button>
      <button class="report-btn btn-print" id="transfer-print-btn" style="display:none;" onclick="printReport('transfer')">
        <i class="fas fa-print"></i> طباعة / PDF
      </button>
    </div>
    <div id="transfer-report" class="report-output"></div>
  </div>
</div>
<!-- Modal للرسائل -->
<div id="modal" class="modal">
  <div class="modal-content" id="modal-content">
    <p id="modal-message"></p>
  </div>
</div>
<script>
// تبديل التبويبات
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});
// رسائل تنبيه
function showMessage(msg, type = 'success') {
  const modal = document.getElementById('modal');
  const content = document.getElementById('modal-content');
  const message = document.getElementById('modal-message');
  message.textContent = msg;
  content.className = 'modal-content ' + type;
  modal.style.display = 'flex';
  setTimeout(() => modal.style.display = 'none', 3500);
}
// تغيير حقل الكمية ديناميكياً
function updateGoldQuantityField() {
  const type = document.getElementById('gold-type').value;
  const container = document.getElementById('quantity-container');
  container.innerHTML = '<label id="quantity-label">الكمية</label>';
  if (type.startsWith('karat-')) {
    container.innerHTML += '<input type="number" step="0.01" min="0.01" id="gold-qty" placeholder="الوزن بالغرام (مثال: 12.50)">';
    document.getElementById('quantity-label').textContent = 'الوزن (g)';
  } else if (type === 'lira') {
    container.innerHTML += `
      <select id="gold-qty">
        <option value="quarter">ربع ليرة</option>
        <option value="half">نص ليرة</option>
        <option value="full">تام</option>
        <option value="republic">جمهوريات</option>
      </select>
    `;
    document.getElementById('quantity-label').textContent = 'نوع الليرة';
  } else if (type === 'bars') {
    container.innerHTML += `
      <select id="gold-qty">
        <option value="1g">1 g</option>
        <option value="5g">5 g</option>
        <option value="10g">10 g</option>
        <option value="20g">20 g</option>
        <option value="25g">25 g</option>
        <option value="31.1g">31.10 g (أونصة)</option>
        <option value="50g">50 g</option>
        <option value="100g">100 g</option>
        <option value="250g">250 g</option>
        <option value="500g">500 g</option>
        <option value="1000g">1000 g (1 kg)</option>
      </select>
    `;
    document.getElementById('quantity-label').textContent = 'وزن السبيكة';
  } else {
    container.innerHTML += '<input type="number" step="0.01" min="0.01" id="gold-qty" disabled placeholder="اختر النوع أولاً">';
    document.getElementById('quantity-label').textContent = 'الكمية';
  }
}
// حفظ عملية ذهب
function saveGold(direction) {
  const typeEl = document.getElementById('gold-type');
  const qtyEl = document.getElementById('gold-qty');
  const total = Number(document.getElementById('gold-total').value) || 0;
  const note = document.getElementById('gold-note').value.trim();
  if (!typeEl.value) return showMessage('يرجى اختيار النوع / العيار أولاً', 'error');
  let qty = qtyEl.tagName === 'SELECT' ? qtyEl.value : Number(qtyEl.value) || 0;
  if (qty <= 0) return showMessage('يرجى إدخال كمية صالحة أكبر من صفر', 'error');
  if (total <= 0) return showMessage('يرجى إدخال سعر إجمالي صالح', 'error');
  const entry = {
    ts: new Date().toISOString(),
    direction,
    type: typeEl.value,
    qty,
    total,
    note
  };
  let arr = JSON.parse(localStorage.getItem('gold') || '[]');
  arr.push(entry);
  localStorage.setItem('gold', JSON.stringify(arr));
  showMessage(`تم حفظ عملية ${direction === 'sell' ? 'بيع' : 'شراء'} بنجاح`, 'success');
  typeEl.value = '';
  updateGoldQuantityField();
  document.getElementById('gold-total').value = '';
  document.getElementById('gold-note').value = '';
}
// حفظ عملية العملات
function saveCurrency(direction) {
  const cur = document.getElementById('cur-type').value;
  const amt = Number(document.getElementById('cur-amount').value) || 0;
  const rate = Number(document.getElementById('cur-rate').value) || 0;
  const note = document.getElementById('cur-note').value.trim();
  if (amt <= 0) return showMessage('المبلغ يجب أن يكون أكبر من صفر', 'error');
  if (rate <= 0) return showMessage('سعر الصرف يجب أن يكون أكبر من صفر', 'error');
  const entry = {
    ts: new Date().toISOString(),
    direction,
    cur,
    amt,
    rate,
    total: amt * rate,
    note
  };
  let arr = JSON.parse(localStorage.getItem('currency') || '[]');
  arr.push(entry);
  localStorage.setItem('currency', JSON.stringify(arr));
  showMessage(`تم حفظ عملية ${direction === 'sell' ? 'بيع' : 'شراء'} ${cur} بنجاح`, 'success');
  document.getElementById('cur-amount').value = '';
  document.getElementById('cur-rate').value = '';
  document.getElementById('cur-note').value = '';
}
// حفظ حوالة
function saveTransfer(direction) {
  const name = document.getElementById('trans-name').value.trim();
  const amt = Number(document.getElementById('trans-amount').value) || 0;
  const com = Number(document.getElementById('trans-commission').value) || 0;
  const cur = document.getElementById('trans-currency').value;
  if (!name) return showMessage('يرجى إدخال الاسم الكامل', 'error');
  if (amt <= 0) return showMessage('المبلغ يجب أن يكون أكبر من صفر', 'error');
  const entry = {
    ts: new Date().toISOString(),
    direction,
    name,
    amt,
    com,
    cur
  };
  let arr = JSON.parse(localStorage.getItem('transfer') || '[]');
  arr.push(entry);
  localStorage.setItem('transfer', JSON.stringify(arr));
  showMessage(`تم حفظ حوالة ${direction === 'out' ? 'صادرة' : 'واردة'} بنجاح`, 'success');
  document.getElementById('trans-name').value = '';
  document.getElementById('trans-amount').value = '';
  document.getElementById('trans-commission').value = '';
}
// عرض التقرير
function generateReport(box, period) {
  const reportDiv = document.getElementById(box + '-report');
  const printBtn = document.getElementById(box + '-print-btn');
  let data = JSON.parse(localStorage.getItem(box) || '[]');
  let now = new Date();
  let start = new Date(now);
  if (period === 'daily') start.setHours(0,0,0,0);
  else start.setDate(now.getDate() - 7);
  let filtered = data.filter(e => new Date(e.ts) >= start);
  if (filtered.length === 0) {
    reportDiv.innerHTML = '<p style="text-align:center; color:#9ca3af; padding:2rem; font-size:1.1rem;">لا توجد عمليات في هذه الفترة</p>';
    reportDiv.classList.add('show');
    printBtn.style.display = 'inline-block';
    return;
  }
  let html = `<h4>تقرير ${period === 'daily' ? 'اليوم' : 'الأسبوع'} – ${now.toLocaleDateString('en-GB')}</h4>`;
  let tableBody = '';
  let totalProfit = 0;
  let stock = {};
  if (box === 'gold') {
    const types = [...new Set(filtered.map(e => e.type))];
    types.forEach(t => {
      let sellQty = 0, sellTotal = 0, buyQty = 0, buyTotal = 0;
      filtered.forEach(e => {
        if (e.type === t) {
          if (e.direction === 'sell') { sellQty += Number(e.qty) || 0; sellTotal += Number(e.total) || 0; }
          if (e.direction === 'buy') { buyQty += Number(e.qty) || 0; buyTotal += Number(e.total) || 0; }
        }
      });
      let profit = sellTotal - buyTotal;
      totalProfit += profit;
      stock[t] = (stock[t] || 0) + (buyQty - sellQty);
      tableBody += `
        <tr>
          <td>${t}</td>
          <td>${sellQty.toFixed(2)} – ${sellTotal.toLocaleString('en-US')} TL</td>
          <td>${buyQty.toFixed(2)} – ${buyTotal.toLocaleString('en-US')} TL</td>
          <td class="${profit >= 0 ? 'positive' : 'negative'}">${profit.toLocaleString('en-US')} TL</td>
        </tr>
      `;
    });
    html += `
      <table class="report-table">
        <thead>
          <tr>
            <th>النوع / العيار</th>
            <th>مبيع</th>
            <th>شراء</th>
            <th>ربح / خسارة</th>
          </tr>
        </thead>
        <tbody>${tableBody}</tbody>
      </table>
      <div class="stock-summary">
        <h5>إجمالي الموجودات حالياً</h5>
        ${Object.entries(stock).map(([t, q]) => `<p><strong>${t}:</strong> ${Number(q).toFixed(2)}</p>`).join('')}
      </div>
      <div class="total-profit ${totalProfit >= 0 ? 'positive' : 'negative'}">
        الربح / الخسارة الإجمالي: ${totalProfit.toLocaleString('en-US')} TL
      </div>
    `;
  } else if (box === 'currency') {
    const currencies = ['EUR', 'USD', 'TRY', 'SAR', 'SYP'];
    currencies.forEach(c => {
      let sellAmt = 0, sellTL = 0, buyAmt = 0, buyTL = 0;
      filtered.forEach(e => {
        if (e.cur === c) {
          if (e.direction === 'sell') { sellAmt += Number(e.amt) || 0; sellTL += Number(e.total) || 0; }
          if (e.direction === 'buy') { buyAmt += Number(e.amt) || 0; buyTL += Number(e.total) || 0; }
        }
      });
      let profit = sellTL - buyTL;
      totalProfit += profit;
      stock[c] = (stock[c] || 0) + (buyAmt - sellAmt);
      if (sellAmt > 0 || buyAmt > 0) {
        tableBody += `
          <tr>
            <td>${c}</td>
            <td>${sellAmt.toFixed(2)} – ${sellTL.toLocaleString('en-US')} TL</td>
            <td>${buyAmt.toFixed(2)} – ${buyTL.toLocaleString('en-US')} TL</td>
            <td class="${profit >= 0 ? 'positive' : 'negative'}">${profit.toLocaleString('en-US')} TL</td>
          </tr>
        `;
      }
    });
    html += `
      <table class="report-table">
        <thead>
          <tr>
            <th>العملة</th>
            <th>مبيع</th>
            <th>شراء</th>
            <th>ربح / خسارة</th>
          </tr>
        </thead>
        <tbody>${tableBody}</tbody>
      </table>
      <div class="stock-summary">
        <h5>إجمالي الموجودات حالياً</h5>
        ${Object.entries(stock).map(([c, a]) => `<p><strong>${c}:</strong> ${Number(a).toFixed(2)}</p>`).join('')}
      </div>
      <div class="total-profit ${totalProfit >= 0 ? 'positive' : 'negative'}">
        الربح / الخسارة الإجمالي: ${totalProfit.toLocaleString('en-US')} TL
      </div>
    `;
  } else if (box === 'transfer') {
    const currencies = ['EUR', 'USD', 'TRY', 'SAR', 'SYP'];
    currencies.forEach(c => {
      let outCom = 0, inCom = 0;
      filtered.forEach(e => {
        if (e.cur === c) {
          if (e.direction === 'out') outCom += Number(e.com) || 0;
          if (e.direction === 'in') inCom += Number(e.com) || 0;
        }
      });
      let com = outCom + inCom;
      totalProfit += com;
      stock[c] = (stock[c] || 0) + (inCom - outCom);
      if (outCom > 0 || inCom > 0) {
        tableBody += `
          <tr>
            <td>${c}</td>
            <td>${outCom.toLocaleString('en-US')} TL</td>
            <td>${inCom.toLocaleString('en-US')} TL</td>
            <td class="positive">${com.toLocaleString('en-US')} TL</td>
          </tr>
        `;
      }
    });
    html += `
      <table class="report-table">
        <thead>
          <tr>
            <th>العملة</th>
            <th>صادرة</th>
            <th>واردة</th>
            <th>إجمالي العمولة</th>
          </tr>
        </thead>
        <tbody>${tableBody}</tbody>
      </table>
      <div class="stock-summary">
        <h5>إجمالي الموجودات حالياً</h5>
        ${Object.entries(stock).map(([c, a]) => `<p><strong>${c}:</strong> ${Number(a).toFixed(2)}</p>`).join('')}
      </div>
      <div class="total-profit positive">
        إجمالي العمولات: ${totalProfit.toLocaleString('en-US')} TL
      </div>
    `;
  }
  reportDiv.innerHTML = html;
  reportDiv.classList.add('show');
  document.getElementById(box + '-print-btn').style.display = 'inline-block';
}
// طباعة التقرير مع اللوغو
function printReport(box) {
  const reportDiv = document.getElementById(box + '-report');
  if (!reportDiv.classList.contains('show')) {
    showMessage('يرجى عرض تقرير أولاً', 'error');
    return;
  }
  const printContent = reportDiv.innerHTML;
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <html>
      <head>
        <title>تقرير ${box}</title>
        <style>
          body { font-family: 'Tajawal', sans-serif; direction: rtl; text-align: right; padding: 30px; font-size: 14px; line-height: 1.6; }
          .print-logo { text-align: center; margin-bottom: 2rem; }
          .print-logo img { max-width: 260px; height: auto; }
          table { width: 100%; border-collapse: collapse; margin: 20px 0; }
          th, td { border: 1px solid #aaa; padding: 10px; }
          th { background: #1e3a8a; color: white; }
          .positive { color: #d4af37; font-weight: bold; }
          .negative { color: #ef4444; font-weight: bold; }
          .stock-summary, .total-profit { margin: 25px 0; padding: 15px; border-radius: 8px; }
          .stock-summary { background: #ecfdf5; border: 1px solid #bbf7d0; }
          .total-profit { background: #eff6ff; border: 1px solid #bfdbfe; text-align: center; font-size: 1.4rem; font-weight: bold; }
        </style>
      </head>
      <body>
        <div class="print-logo">
          <img src="logo.png" alt="SARRAFALAR ÇAVUŞ">
        </div>
        ${printContent}
      </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
}
</script>
</body>
</html>
